$OpenBSD: patch-src_lib_openssl-compat_h,v 1.2 2018/02/16 12:12:26 sthen Exp $

Index: src/lib/openssl-compat.h
--- src/lib/openssl-compat.h.orig
+++ src/lib/openssl-compat.h
@@ -1,13 +1,21 @@
 #ifndef __OPENSSL_COPMAT__H__
 #define __OPENSSL_COPMAT__H__
 
-#if (OPENSSL_VERSION_NUMBER < 0x10100000L)
+#if (OPENSSL_VERSION_NUMBER < 0x10100000L) || \
+    (defined(LIBRESSL_VERSION_NUMBER) && LIBRESSL_VERSION_NUMBER < 0x2070000fL)
 static inline int EVP_PKEY_up_ref(EVP_PKEY *pkey)
 {
 	CRYPTO_add(&pkey->references, 1, CRYPTO_LOCK_EVP_PKEY);
 	return 1;
 }
 
+static inline const unsigned char *ASN1_STRING_get0_data(const ASN1_STRING *asn1)
+{
+	return asn1->data;
+}
+#endif
+
+#if (OPENSSL_VERSION_NUMBER < 0x10100000L) || defined(LIBRESSL_VERSION_NUMBER)
 static inline void EVP_CIPHER_CTX_reset(EVP_CIPHER_CTX *ctx)
 {
 	EVP_CIPHER_CTX_init(ctx);
@@ -32,11 +40,6 @@ static inline void EVP_MD_CTX_free(EVP_MD_CTX *ctx)
 {
 	EVP_MD_CTX_reset(ctx);
 	OPENSSL_free(ctx);
-}
-
-static inline const unsigned char *ASN1_STRING_get0_data(const ASN1_STRING *asn1)
-{
-	return asn1->data;
 }
 #endif
 
