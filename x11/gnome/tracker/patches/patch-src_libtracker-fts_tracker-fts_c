$OpenBSD: patch-src_libtracker-fts_tracker-fts_c,v 1.1 2019/01/04 08:56:44 ajacoutot Exp $

From fedb4d58557a5d34ab3fdd7869a05bd87aff7193 Mon Sep 17 00:00:00 2001
From: Carlos Garnacho <carlosg@gnome.org>
Date: Thu, 8 Nov 2018 12:40:36 +0100
Subject: [PATCH] libtracker-data: Drop FTS table/view before ontology updates

Index: src/libtracker-fts/tracker-fts.c
--- src/libtracker-fts/tracker-fts.c.orig
+++ src/libtracker-fts/tracker-fts.c
@@ -158,6 +158,26 @@ tracker_fts_create_table (sqlite3    *db,
 }
 
 gboolean
+tracker_fts_delete_table (sqlite3 *db,
+                          gchar   *table_name)
+{
+	gchar *query;
+	int rc;
+
+	query = g_strdup_printf ("DROP VIEW fts_view");
+	rc = sqlite3_exec (db, query, NULL, NULL, NULL);
+	g_free (query);
+
+	if (rc == SQLITE_OK) {
+		query = g_strdup_printf ("DROP TABLE %s", table_name);
+		sqlite3_exec (db, query, NULL, NULL, NULL);
+		g_free (query);
+	}
+
+	return rc == SQLITE_OK;
+}
+
+gboolean
 tracker_fts_alter_table (sqlite3    *db,
 			 gchar      *table_name,
 			 GHashTable *tables,
@@ -167,18 +187,6 @@ tracker_fts_alter_table (sqlite3    *db,
 	int rc;
 
 	tmp_name = g_strdup_printf ("%s_TMP", table_name);
-
-	query = g_strdup_printf ("DROP VIEW fts_view");
-	rc = sqlite3_exec (db, query, NULL, NULL, NULL);
-	g_free (query);
-
-	query = g_strdup_printf ("DROP TABLE %s", tmp_name);
-	rc = sqlite3_exec (db, query, NULL, NULL, NULL);
-	g_free (query);
-
-	query = g_strdup_printf ("DROP TABLE %s", table_name);
-	rc = sqlite3_exec (db, query, NULL, NULL, NULL);
-	g_free (query);
 
 	if (!tracker_fts_create_table (db, tmp_name, tables, grouped_columns)) {
 		g_free (tmp_name);
