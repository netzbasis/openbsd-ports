$OpenBSD: patch-src_compositor_meta-shaped-texture_c,v 1.1 2015/06/27 10:59:09 ajacoutot Exp $

From 351f444f9d16a90636feb217b15f0f376bf96d85 Mon Sep 17 00:00:00 2001
From: "Jasper St. Pierre" <jstpierre@mecheye.net>
Date: Tue, 23 Jun 2015 16:23:45 -0700
Subject: surface-actor-x11: Make sure to set a size when unredirected

--- src/compositor/meta-shaped-texture.c.orig	Thu Mar 26 18:02:38 2015
+++ src/compositor/meta-shaped-texture.c	Sat Jun 27 12:52:20 2015
@@ -86,6 +86,7 @@ struct _MetaShapedTexturePrivate
   cairo_region_t *unobscured_region;
 
   guint tex_width, tex_height;
+  guint fallback_width, fallback_height;
 
   guint create_mipmaps : 1;
 };
@@ -136,7 +137,20 @@ set_unobscured_region (MetaShapedTexture *self,
   g_clear_pointer (&priv->unobscured_region, (GDestroyNotify) cairo_region_destroy);
   if (unobscured_region)
     {
-      cairo_rectangle_int_t bounds = { 0, 0, priv->tex_width, priv->tex_height };
+      guint width, height;
+
+      if (priv->texture)
+        {
+          width = priv->tex_width;
+          height = priv->tex_height;
+        }
+      else
+        {
+          width = priv->fallback_width;
+          height = priv->fallback_height;
+        }
+
+      cairo_rectangle_int_t bounds = { 0, 0, width, height };
       priv->unobscured_region = cairo_region_copy (unobscured_region);
       cairo_region_intersect_rectangle (priv->unobscured_region, &bounds);
     }
@@ -499,16 +513,21 @@ meta_shaped_texture_get_preferred_width (ClutterActor 
                                          gfloat       *natural_width_p)
 {
   MetaShapedTexturePrivate *priv;
+  guint width;
 
   g_return_if_fail (META_IS_SHAPED_TEXTURE (self));
 
   priv = META_SHAPED_TEXTURE (self)->priv;
 
-  if (min_width_p)
-    *min_width_p = priv->tex_width;
+  if (priv->texture)
+    width = priv->tex_width;
+  else
+    width = priv->fallback_width;
 
+  if (min_width_p)
+    *min_width_p = width;
   if (natural_width_p)
-    *natural_width_p = priv->tex_width;
+    *natural_width_p = width;
 }
 
 static void
@@ -518,16 +537,21 @@ meta_shaped_texture_get_preferred_height (ClutterActor
                                           gfloat       *natural_height_p)
 {
   MetaShapedTexturePrivate *priv;
+  guint height;
 
   g_return_if_fail (META_IS_SHAPED_TEXTURE (self));
 
   priv = META_SHAPED_TEXTURE (self)->priv;
 
-  if (min_height_p)
-    *min_height_p = priv->tex_height;
+  if (priv->texture)
+    height = priv->tex_height;
+  else
+    height = priv->fallback_height;
 
+  if (min_height_p)
+    *min_height_p = height;
   if (natural_height_p)
-    *natural_height_p = priv->tex_height;
+    *natural_height_p = height;
 }
 
 static cairo_region_t *
@@ -858,6 +882,17 @@ meta_shaped_texture_get_image (MetaShapedTexture     *
     }
 
   return surface;
+}
+
+void
+meta_shaped_texture_set_fallback_size (MetaShapedTexture *self,
+                                       guint              fallback_width,
+                                       guint              fallback_height)
+{
+  MetaShapedTexturePrivate *priv = self->priv;
+
+  priv->fallback_width = fallback_width;
+  priv->fallback_height = fallback_height;
 }
 
 static void
