$OpenBSD: patch-src_meson_build,v 1.1 2018/04/28 13:18:19 ajacoutot Exp $

From a5a64a09f2f49d6eabc5588484536064b24b66ff Mon Sep 17 00:00:00 2001
From: Ernestas Kulik <ernestask@gnome.org>
Date: Sat, 28 Apr 2018 14:50:42 +0300
Subject: [PATCH] build: Pass dependency to resource header

Index: src/meson.build
--- src/meson.build.orig
+++ src/meson.build
@@ -1,3 +1,13 @@
+resources = gnome.compile_resources(
+  'nautilus-resources',
+  join_paths(
+    'resources', 'nautilus.gresource.xml'
+  ),
+  source_dir: 'resources',
+  c_name: 'nautilus',
+  extra_args: '--manual-register'
+)
+
 libnautilus_sources = [
   gnome.mkenums(
     'nautilus-enum-types',
@@ -10,15 +20,8 @@ libnautilus_sources = [
       'nautilus-search-provider.h'
     ]
   ),
-  gnome.compile_resources(
-    'nautilus-resources',
-    join_paths(
-      'resources', 'nautilus.gresource.xml'
-    ),
-    source_dir: 'resources',
-    c_name: 'nautilus',
-    extra_args: '--manual-register'
-  ),
+  # The header is only used by the main executable, no need to add it here.
+  resources[0],
   gnome.gdbus_codegen(
     'nautilus-freedesktop-generated',
     join_paths(
@@ -294,7 +297,11 @@ libnautilus_dep = declare_dependency(
     nautilus_include_dirs,
     libnautilus_include_dirs
   ],
-  dependencies: nautilus_deps
+  dependencies: nautilus_deps,
+  # If any dependent target uses generated sources that are part of libnautilus,
+  # they need to be passed on, as otherwise only the link order is enforced.
+  # resources[1] is the header, generated by glib-compile-resources.
+  sources: resources[1]
 )
 
 nautilus = executable(
