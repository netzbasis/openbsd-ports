$OpenBSD: patch-src_librustdoc_test_rs,v 1.4 2016/10/25 17:08:07 danj Exp $
fallback to CFG_PREFIX as default sysroot.
--- src/librustdoc/test.rs.orig	Wed Oct 19 23:51:02 2016
+++ src/librustdoc/test.rs	Sat Oct 22 15:28:15 2016
@@ -63,9 +63,16 @@ pub fn run(input: &str,
     let input_path = PathBuf::from(input);
     let input = config::Input::File(input_path.clone());
 
+    let sysroot = match env::current_exe().ok() {
+        Some(mut p) => { p.pop(); p.pop(); p }
+        None => match option_env!("CFG_PREFIX") {
+            Some(dir) => PathBuf::from(dir),
+            None => panic!("can't determine value for sysroot"),
+        }
+    };
+
     let sessopts = config::Options {
-        maybe_sysroot: Some(env::current_exe().unwrap().parent().unwrap()
-                                              .parent().unwrap().to_path_buf()),
+        maybe_sysroot: Some(sysroot),
         search_paths: libs.clone(),
         crate_types: vec!(config::CrateTypeDylib),
         externs: externs.clone(),
@@ -184,9 +191,16 @@ fn runtest(test: &str, cratename: &str, cfgs: Vec<Stri
     };
     let outputs = OutputTypes::new(&[(OutputType::Exe, None)]);
 
+    let sysroot = match env::current_exe().ok() {
+        Some(mut p) => { p.pop(); p.pop(); p }
+        None => match option_env!("CFG_PREFIX") {
+            Some(dir) => PathBuf::from(dir),
+            None => panic!("can't determine value for sysroot"),
+        }
+    };
+
     let sessopts = config::Options {
-        maybe_sysroot: Some(env::current_exe().unwrap().parent().unwrap()
-                                              .parent().unwrap().to_path_buf()),
+        maybe_sysroot: Some(sysroot),
         search_paths: libs,
         crate_types: vec!(config::CrateTypeExecutable),
         output_types: outputs,
