$OpenBSD: patch-hw_virtio_virtio_c,v 1.2 2017/04/10 13:13:02 ajacoutot Exp $

virtio: Fix no interrupt when not creating msi controller

--- hw/virtio/virtio.c.orig	Fri Mar 31 10:07:03 2017
+++ hw/virtio/virtio.c	Sun Apr  9 12:21:46 2017
@@ -1387,6 +1387,12 @@ void virtio_notify_irqfd(VirtIODevice *vdev, VirtQueue
     event_notifier_set(&vq->guest_notifier);
 }
 
+static void virtio_irq(VirtQueue *vq)
+{
+    virtio_set_isr(vq->vdev, 0x1);
+    virtio_notify_vector(vq->vdev, vq->vector);
+}
+
 void virtio_notify(VirtIODevice *vdev, VirtQueue *vq)
 {
     if (!virtio_should_notify(vdev, vq)) {
@@ -1394,8 +1400,7 @@ void virtio_notify(VirtIODevice *vdev, VirtQueue *vq)
     }
 
     trace_virtio_notify(vdev, vq);
-    virtio_set_isr(vq->vdev, 0x1);
-    virtio_notify_vector(vdev, vq->vector);
+    virtio_irq(vq);
 }
 
 void virtio_notify_config(VirtIODevice *vdev)
@@ -2023,7 +2028,7 @@ static void virtio_queue_guest_notifier_read(EventNoti
 {
     VirtQueue *vq = container_of(n, VirtQueue, guest_notifier);
     if (event_notifier_test_and_clear(n)) {
-        virtio_notify_vector(vq->vdev, vq->vector);
+        virtio_irq(vq);
     }
 }
 
