$OpenBSD: patch-lib_nfkc_c,v 1.1 2016/07/22 12:27:42 sthen Exp $

Backport security fixes from libidn 1.33
https://lists.gnu.org/archive/html/help-libidn/2016-07/msg00009.html

--- lib/nfkc.c.orig	Wed Jul  8 00:25:30 2015
+++ lib/nfkc.c	Thu Jul 21 17:08:52 2016
@@ -1086,6 +1086,16 @@ stringprep_ucs4_to_utf8 (const uint32_t * str, ssize_t
 char *
 stringprep_utf8_nfkc_normalize (const char *str, ssize_t len)
 {
+  size_t n;
+
+  if (len < 0)
+    n = strlen (str);
+  else
+    n = len;
+
+  if (u8_check ((const uint8_t *) str, n))
+    return NULL;
+
   return g_utf8_normalize (str, len, G_NORMALIZE_NFKC);
 }
 
