$OpenBSD: patch-jdk_src_solaris_native_java_lang_childproc_c,v 1.2 2019/06/17 19:21:38 kurt Exp $

Use closefrom(2) in child process. Upstream final version.

Index: jdk/src/solaris/native/java/lang/childproc.c
--- jdk/src/solaris/native/java/lang/childproc.c.orig
+++ jdk/src/solaris/native/java/lang/childproc.c
@@ -62,7 +62,33 @@ isAsciiDigit(char c)
   return c >= '0' && c <= '9';
 }
 
-#ifdef _ALLBSD_SOURCE
+#if defined(_ALLBSD_SOURCE) && !defined(MACOSX)
+/*
+ * Quoting POSIX: "If a multi-threaded process calls fork(), the new
+ * process shall contain a replica of the calling thread and its entire
+ * address space, possibly including the states of mutexes and other
+ * resources. Consequently, to avoid errors, the child process may only
+ * execute async-signal-safe operations until such time as one of the exec
+ * functions is called."
+ *
+ * opendir and readir are not async-signal-safe and can deadlock when
+ * called after fork or vfork (and before exec) so use closefrom syscall
+ * which is safe to call after forking.
+ */
+int
+closeDescriptors(void)
+{
+#if defined(__FreeBSD__)
+    closefrom(FAIL_FILENO + 1);
+#else
+    int err;
+    RESTARTABLE(closefrom(FAIL_FILENO + 1), err);
+#endif
+    return 1;
+}
+#else
+
+#ifdef MACOSX
 #define FD_DIR "/dev/fd"
 #define dirent64 dirent
 #define readdir64 readdir
@@ -113,6 +139,7 @@ closeDescriptors(void)
 
     return 1;
 }
+#endif /* defined(_ALLBSD_SOURCE) && !defined(MACOSX) */
 
 int
 moveDescriptor(int fd_from, int fd_to)
