$OpenBSD: patch-jdk_src_solaris_native_java_lang_childproc_c,v 1.1 2019/05/28 17:37:40 kurt Exp $

Index: jdk/src/solaris/native/java/lang/childproc.c
--- jdk/src/solaris/native/java/lang/childproc.c.orig
+++ jdk/src/solaris/native/java/lang/childproc.c
@@ -62,6 +62,28 @@ isAsciiDigit(char c)
   return c >= '0' && c <= '9';
 }
 
+#if defined(__OpenBSD__)
+/*
+ * Quoting POSIX: "If a multi-threaded process calls fork(), the new
+ * process shall contain a replica of the calling thread and its entire
+ * address space, possibly including the states of mutexes and other
+ * resources. Consequently, to avoid errors, the child process may only
+ * execute async-signal-safe operations until such time as one of the exec
+ * functions is called."
+ *
+ * opendir and readir are not async-signal-safe and can deadlock when
+ * called after fork or vfork (and before exec) so use closefrom syscall
+ * which is safe to call after forking.
+ */
+int
+closeDescriptors(void)
+{
+    int err;
+    RESTARTABLE(closefrom(FAIL_FILENO + 1), err);
+    return err;
+}
+#else
+
 #ifdef _ALLBSD_SOURCE
 #define FD_DIR "/dev/fd"
 #define dirent64 dirent
@@ -113,6 +135,7 @@ closeDescriptors(void)
 
     return 1;
 }
+#endif /* __OpenBSD__ */
 
 int
 moveDescriptor(int fd_from, int fd_to)
