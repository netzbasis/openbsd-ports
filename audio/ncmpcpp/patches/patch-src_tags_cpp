$OpenBSD: patch-src_tags_cpp,v 1.1 2014/11/04 10:52:25 dcoppa Exp $

commit 6402b6f9c9aad20180079d8b35f55267634028f2
Author: Andrzej Rybczak <electricityispower@gmail.com>
Date:   Tue Oct 28 20:07:07 2014 +0100

tags: writeID3v2Tags: write comment tag properly

--- src/tags.cpp.orig	Sat Oct 25 17:16:07 2014
+++ src/tags.cpp	Tue Nov  4 10:32:30 2014
@@ -31,10 +31,12 @@
 #include <vorbisfile.h>
 #include <tag.h>
 #include <textidentificationframe.h>
+#include <commentsframe.h>
 #include <xiphcomment.h>
 
 #include "global.h"
 #include "settings.h"
+#include "utility/string.h"
 #include "utility/wide_string.h"
 
 namespace {//
@@ -151,9 +153,20 @@ void writeID3v2Tags(const MPD::MutableSong &s, TagLib:
 		tag->removeFrames(type);
 		if (!list.isEmpty())
 		{
-			auto frame = new TagLib::ID3v2::TextIdentificationFrame(type, TagLib::String::UTF8);
-			frame->setText(list);
-			tag->addFrame(frame);
+			if (type == "COMM") // comment needs to be handled separately
+			{
+				auto frame = new TagLib::ID3v2::CommentsFrame(TagLib::String::UTF8);
+				// apparently there can't be multiple comments,
+				// so if there is more than one, join them.
+				frame->setText(join(list, TagLib::String(Config.tags_separator, TagLib::String::UTF8)));
+				tag->addFrame(frame);
+			}
+			else
+			{
+				auto frame = new TagLib::ID3v2::TextIdentificationFrame(type, TagLib::String::UTF8);
+				frame->setText(list);
+				tag->addFrame(frame);
+			}
 		}
 	};
 	writeID3v2("TIT2", tagList(s, &MPD::Song::getTitle));
