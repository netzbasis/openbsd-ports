$OpenBSD: patch-bin_dig_dig_c,v 1.12 2019/12/17 00:46:15 sthen Exp $

Index: bin/dig/dig.c
--- bin/dig/dig.c.orig
+++ bin/dig/dig.c
@@ -2251,6 +2251,13 @@ void dig_setup(int argc, char **argv)
 	ISC_LIST_INIT(server_list);
 	ISC_LIST_INIT(search_list);
 
+	/* unix needed for startup check, isc_net_probeunix, used in
+	   bin/named/controlconf.c, can probably be hardcoded instead? */
+	if (pledge("stdio rpath inet unix dns", NULL) == -1) {
+		perror("pledge");
+		exit(1);
+	}
+
 	debug("dig_setup()");
 
 	/* setup dighost callbacks */
@@ -2282,6 +2289,15 @@ void dig_query_setup(bool is_batchfile, bool config_on
 		setup_file_key();
 	else if (keysecret[0] != 0)
 		setup_text_key();
+
+	/* inet because we might want to query port != 53. dns for resolv.conf.
+	   used to have rpath for IDN charset conversion here but that seems
+	   to not be needed any more? */
+	if (pledge("stdio inet dns", NULL) == -1) {
+		perror("pledge");
+		exit(1);
+	}
+
 	if (domainopt[0] != '\0') {
 		set_search_domain(domainopt);
 		usesearch = true;
