$OpenBSD: patch-bin_dig_host_c,v 1.12 2019/12/18 19:38:17 sthen Exp $

Index: bin/dig/host.c
--- bin/dig/host.c.orig
+++ bin/dig/host.c
@@ -17,6 +17,7 @@
 #include <stdbool.h>
 #include <stdlib.h>
 #include <limits.h>
+#include <unistd.h>
 
 #ifdef HAVE_LOCALE_H
 #include <locale.h>
@@ -874,6 +875,15 @@ main(int argc, char **argv) {
 	dighost_trying = trying;
 	dighost_shutdown = host_shutdown;
 
+	/*
+	 * unix: needed for startup check, isc_net_probeunix. can probably be
+	 *       hardcoded instead? (unix sockets used in controlconf).
+	 */
+	if (pledge("stdio rpath inet unix dns", NULL) == -1) {
+		perror("pledge");
+		exit(1);
+	}
+
 	debug("main()");
 	progname = argv[0];
 	pre_parse_args(argc, argv);
@@ -886,6 +896,16 @@ main(int argc, char **argv) {
 		setup_file_key();
 	else if (keysecret[0] != 0)
 		setup_text_key();
+
+	/*
+	 * dns:   resolv.conf, also allows port 53 sockets
+	 * inet:  needed if we query on port != 53
+	*/
+	if (pledge("stdio inet dns", NULL) == -1) {
+		perror("pledge");
+		exit(1);
+	}
+
 	result = isc_app_onrun(mctx, global_task, onrun_callback, NULL);
 	check_result(result, "isc_app_onrun");
 	isc_app_run();
