$OpenBSD: patch-includes_discovery_sensors-openbsd_inc_php,v 1.1 2015/10/12 15:39:06 sthen Exp $

From 92c2b3a14ef3471cbbf1e39871784f9879e2f51a Mon Sep 17 00:00:00 2001
From: sthen <stu@spacehopper.org>
Date: Mon, 12 Oct 2015 15:14:55 +0100
Subject: [PATCH 1/3] add MIBs for OpenBSD's snmpd

From 2544dfedb5f69f1e55176d4c14fb7615931340fe Mon Sep 17 00:00:00 2001
From: sthen <stu@spacehopper.org>
Date: Mon, 12 Oct 2015 15:15:14 +0100
Subject: [PATCH 2/3] detect OpenBSD sensors

From 5edf96223f994a0246e28c733d02b469d3a76e65 Mon Sep 17 00:00:00 2001
From: sthen <stu@spacehopper.org>
Date: Mon, 12 Oct 2015 15:52:58 +0100
Subject: [PATCH 3/3] fix descriptions

--- includes/discovery/sensors-openbsd.inc.php.orig	Mon Oct 12 15:08:11 2015
+++ includes/discovery/sensors-openbsd.inc.php	Mon Oct 12 16:14:10 2015
@@ -0,0 +1,67 @@
+<?php
+
+echo ' OPENBSD-SENSORS-MIB: ';
+
+echo 'Caching OIDs:';
+
+$oids = array();
+echo ' sensorDevice';
+$oids = snmpwalk_cache_multi_oid($device, 'sensorDevice', $oids, 'OPENBSD-SENSORS-MIB');
+echo ' sensorDescr';
+$oids = snmpwalk_cache_multi_oid($device, 'sensorDescr', $oids, 'OPENBSD-SENSORS-MIB');
+echo ' sensorValue';
+$oids = snmpwalk_cache_multi_oid($device, 'sensorValue', $oids, 'OPENBSD-SENSORS-MIB');
+echo ' sensorType';
+$oids = snmpwalk_cache_multi_oid($device, 'sensorType', $oids, 'OPENBSD-SENSORS-MIB');
+
+# temperature(0), fan(1), voltsdc(2), voltsac(3), resistance(4), power(5),
+# current(6), watthour(7), amphour(8), indicator(9), raw(10), percent(11),
+# illuminance(12), drive(13), timedelta(14), humidity(15), freq(16),
+# angle(17), distance(18), pressure(19), accel(20)
+
+$entitysensor['voltsdc']   = 'voltage';
+$entitysensor['voltsac']   = 'voltage';
+$entitysensor['fan']       = 'fanspeed';
+
+$entitysensor['current']   = 'current';
+$entitysensor['power']     = 'power';
+$entitysensor['freq']      = 'freq';
+$entitysensor['humidity']  = 'humidity';
+$entitysensor['temperature'] = 'temperature';
+
+if (is_array($oids)) {
+    foreach ($oids as $index => $entry) {
+        // echo("[" . $entry['sensorType'] . "|" . $entry['sensorValue']. "|" . $index . "\n");
+        if ($entitysensor[$entry['sensorType']] && is_numeric($entry['sensorValue']) && is_numeric($index)) {
+            $entPhysicalIndex = $index;
+            $oid              = '.1.3.6.1.4.1.30155.2.1.2.1.5.'.$index;
+            $current          = $entry['sensorValue'];
+            $descr = $entry['sensorDevice'].' '.$entry['sensorDescr'];
+            $bogus = false;
+
+            $type = $entitysensor[$entry['sensorType']];
+
+            if ($type == 'voltage') {
+                $descr = preg_replace('/ voltage/i', '', $descr);
+            }
+
+            if ($type == 'temperature') {
+                if ($current < -40 || $current > 200) {
+                    $bogus = true;
+                }
+                $descr = preg_replace('/ temperature/i', '', $descr);
+            }
+
+            if ($current == '-127') {
+                $bogus = true;
+            }
+
+            // echo($descr . "|" . $index . "|" .$current . "|" . $bogus . "\n");
+            if (! $bogus) {
+                discover_sensor($valid['sensor'], $type, $device, $oid, $index, 'openbsd-sensor', $descr, '1', '1', null, null, null, null, $current);
+            }
+        }//end if
+    }//end foreach
+}//end if
+
+echo "\n";
