$OpenBSD: patch-lib_compat_externalcommandlistener_cpp,v 1.1 2015/11/09 22:36:38 sthen Exp $

commit 9ea51aa86edac407411376d2ed18a494368b9e31
Author: Gunnar Beutner <gunnar@beutner.name>
Date:   Mon Nov 9 20:39:26 2015 +0100

    Use non-blocking open() for the command pipe

    fixes #10410

--- lib/compat/externalcommandlistener.cpp.orig	Mon Oct 19 10:14:40 2015
+++ lib/compat/externalcommandlistener.cpp	Mon Nov  9 21:42:01 2015
@@ -93,17 +93,15 @@ void ExternalCommandListener::CommandPipeThread(const 
 	}
 
 	for (;;) {
-		int fd;
+		int fd = open(commandPath.CStr(), O_RDONLY | O_NONBLOCK);
 
-		do {
-			fd = open(commandPath.CStr(), O_RDONLY);
-		} while (fd < 0 && errno == EINTR);
-
 		if (fd < 0) {
 			Log(LogCritical, "ExternalCommandListener")
 			    << "open() for fifo path '" << commandPath << "' failed with error code " << errno << ", \"" << Utility::FormatErrorNumber(errno) << "\"";
 			return;
 		}
+
+		Utility::SetNonBlocking(fd, false);
 
 		FILE *fp = fdopen(fd, "r");
 
