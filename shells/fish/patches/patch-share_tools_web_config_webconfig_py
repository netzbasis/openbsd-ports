$OpenBSD: patch-share_tools_web_config_webconfig_py,v 1.1 2020/02/08 15:35:55 abieber Exp $

https://github.com/fish-shell/fish-shell/pull/6522

Index: share/tools/web_config/webconfig.py
--- share/tools/web_config/webconfig.py.orig
+++ share/tools/web_config/webconfig.py
@@ -1,4 +1,4 @@
-#!/usr/bin/env python
+#!/usr/local/bin/python3.7
 
 from __future__ import unicode_literals
 from __future__ import print_function
@@ -21,6 +21,7 @@ import socket
 import string
 import subprocess
 import sys
+import tempfile
 from itertools import chain
 
 FISH_BIN_PATH = False  # will be set later
@@ -1172,31 +1173,13 @@ url = 'http://localhost:%d/%s/%s' % (PORT, authkey, in
 # Create temporary file to hold redirect to real server. This prevents exposing
 # the URL containing the authentication key on the command line (see
 # CVE-2014-2914 or https://github.com/fish-shell/fish-shell/issues/1438).
-if 'XDG_CACHE_HOME' in os.environ:
-    dirname = os.path.expanduser(os.path.expandvars('$XDG_CACHE_HOME/fish/'))
-else:
-    dirname = os.path.expanduser('~/.cache/fish/')
-
-os.umask(0o0077)
-try:
-    os.makedirs(dirname, 0o0700)
-except OSError as e:
-    if e.errno == 17:
-        pass
-    else:
-        raise e
-
-randtoken = ''.join(random.choice(string.ascii_uppercase + string.digits)
-                    for _ in range(6))
-filename = dirname + 'web_config-%s.html' % randtoken
-
-f = open(filename, 'w')
+f = tempfile.NamedTemporaryFile(prefix='web_config_', suffix='.html', mode='w')
 f.write(redirect_template_html % (url, url))
-f.close()
+f.flush()
 
 # Open temporary file as URL
 # Use open on macOS >= 10.12.5 to work around #4035.
-fileurl = 'file://' + filename
+fileurl = 'file://' + f.name
 print("Web config started at '%s'. Hit enter to stop." % fileurl)
 if isMacOS10_12_5_OrLater():
     subprocess.check_call(['open', fileurl])
@@ -1221,4 +1204,4 @@ except KeyboardInterrupt:
     print("\nShutting down.")
 
 # Clean up temporary file
-os.remove(filename)
+f.close()
