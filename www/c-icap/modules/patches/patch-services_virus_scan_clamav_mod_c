$OpenBSD: patch-services_virus_scan_clamav_mod_c,v 1.3 2018/12/04 14:18:57 sthen Exp $

XXX quick fix for libclamav 0.101

Index: services/virus_scan/clamav_mod.c
--- services/virus_scan/clamav_mod.c.orig
+++ services/virus_scan/clamav_mod.c
@@ -123,7 +123,7 @@ struct virus_db {
 #ifndef HAVE_LIBCLAMAV_095
 struct cl_limits limits;
 #endif
-unsigned int CLAMSCAN_OPTIONS = CL_SCAN_STDOPT;
+struct cl_scan_options CLAMSCAN_OPTIONS;
 
 struct virus_db *virusdb = NULL;
 struct virus_db *old_virusdb = NULL;
@@ -168,6 +168,8 @@ int clamav_post_init(struct ci_server_conf *server_con
 
      limits.archivememlim = 0;  /* disable memory limit for bzip2 scanner */
 #else
+     memset(&CLAMSCAN_OPTIONS, 0, sizeof(struct cl_scan_options));
+
      if(!virusdb) /* ??????? */
 	 return CI_ERROR;
 
@@ -186,30 +188,18 @@ int clamav_post_init(struct ci_server_conf *server_con
 #endif
 
      /*Build scan options*/
-#if defined(CL_SCAN_BLOCKENCRYPTED)
      if (CLAMAV_BLOCKENCRYPTED)
-         CLAMSCAN_OPTIONS |= CL_SCAN_BLOCKENCRYPTED;
-#endif
-#if defined(CL_SCAN_BLOCKBROKEN)
+         CLAMSCAN_OPTIONS.heuristic |= CL_SCAN_HEURISTIC_ENCRYPTED_ARCHIVE | CL_SCAN_HEURISTIC_ENCRYPTED_DOC;
      if (CLAMAV_BLOCKBROKEN)
-         CLAMSCAN_OPTIONS |= CL_SCAN_BLOCKBROKEN;
-#endif
-#if defined(CL_SCAN_HEURISTIC_PRECEDENCE)
+         CLAMSCAN_OPTIONS.heuristic |= CL_SCAN_HEURISTIC_BROKEN;
      if (CLAMAV_HEURISTIC_PRECEDENCE)
-         CLAMSCAN_OPTIONS |= CL_SCAN_HEURISTIC_PRECEDENCE;
-#endif
-#if defined(CL_SCAN_BLOCKMACROS)
+         CLAMSCAN_OPTIONS.general |= CL_SCAN_GENERAL_HEURISTIC_PRECEDENCE;
      if (CLAMAV_BLOCKMACROS)
-         CLAMSCAN_OPTIONS |= CL_SCAN_BLOCKMACROS;
-#endif
-#if defined(CL_SCAN_PHISHING_BLOCKSSL)
+         CLAMSCAN_OPTIONS.heuristic |= CL_SCAN_HEURISTIC_MACROS;
      if (CLAMAV_PHISHING_BLOCKSSL)
-         CLAMSCAN_OPTIONS |= CL_SCAN_PHISHING_BLOCKSSL;
-#endif
-#if defined(CL_SCAN_PHISHING_BLOCKCLOAK)
+         CLAMSCAN_OPTIONS.heuristic |= CL_SCAN_HEURISTIC_PHISHING_SSL_MISMATCH;
      if (CLAMAV_PHISHING_BLOCKCLOAK)
-         CLAMSCAN_OPTIONS |= CL_SCAN_PHISHING_BLOCKCLOAK;
-#endif
+         CLAMSCAN_OPTIONS.heuristic |= CL_SCAN_HEURISTIC_PHISHING_CLOAK;
 
      clamav_set_versions();
      av_register_engine(&clamav_engine);
@@ -489,8 +479,8 @@ int clamav_scan_simple_file(ci_simple_file_t *body, av
                      CLAMSCAN_OPTIONS);
 #else
      ret =
-         cl_scandesc(fd, &virname, &scanned_data, vdb,
-                     CLAMSCAN_OPTIONS);
+         cl_scandesc(fd, NULL, &virname, &scanned_data, vdb,
+                     &CLAMSCAN_OPTIONS);
 #endif
 
      status = 1;
